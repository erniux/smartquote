# =======================================================
# ğŸš€ Django CI Workflow
# Ejecuta validaciones automÃ¡ticas del backend (Django)
# en cualquier rama o manualmente desde GitHub.
# =======================================================

name: ğŸ¦ Django CI

on:
  push:
    branches:
      - "**"                # Ejecutar en cualquier rama
  pull_request:
    branches:
      - "**"                # Ejecutar tambiÃ©n en cualquier PR
  workflow_dispatch:         # Permitir ejecuciÃ³n manual

jobs:
  build:
    runs-on: ubuntu-latest

    # ==============================
    # ğŸ” Variables y Secrets
    # ==============================
    env:
      DATABASE_NAME: smartquote
      DATABASE_USER: mi_usuario
      DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      ALLOWED_HOSTS: localhost,127.0.0.1
      DJANGO_SETTINGS_MODULE: smartquote.settings
      DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}

      DJANGO_SUPERUSER_USERNAME: admin
      DJANGO_SUPERUSER_EMAIL: admin@example.com
      DJANGO_SUPERUSER_PASSWORD: admin123
      DJANGO_SUPERUSER_ROLE: admin

    # ==============================
    # ğŸ“¦ Servicios requeridos
    # ==============================
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: smartquote
          POSTGRES_USER: mi_usuario
          POSTGRES_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
        options: >-
          --health-cmd="pg_isready -U mi_usuario -d smartquote"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    # ==============================
    # âš™ï¸ Pasos del pipeline
    # ==============================
    steps:
      - name: ğŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Compose
        run: |
          sudo apt-get update && sudo apt-get install -y docker-compose

      - name: ğŸ§± Build containers
        run: docker compose build

      - name: âœ… Run Django system check
        run: docker compose run --rm backend python manage.py check

      - name: ğŸ—ƒï¸ Run migrations
        run: docker compose run --rm backend python manage.py migrate --noinput

      - name: ğŸ§ª Run tests
        run: docker compose run --rm backend python manage.py test --noinput

